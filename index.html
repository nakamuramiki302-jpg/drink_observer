<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é£²ã¿éãalert</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }

    #root {
      min-height: 100vh;
      position: relative;
    }

    .emoji-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
      background-color: #FFFACD;
    }

    .emoji {
      position: absolute;
      font-size: 3rem;
      opacity: 0.3;
      user-select: none;
      animation: float 20s infinite ease-in-out;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0px) rotate(0deg);
      }

      50% {
        transform: translateY(-20px) rotate(5deg);
      }
    }

    .content-wrapper {
      position: relative;
      z-index: 1;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 215, 0, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .drink-button {
      transition: all 0.3s ease;
      transform: scale(1);
    }

    .drink-button:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(255, 165, 0, 0.4);
    }

    .drink-button:active {
      transform: scale(0.95);
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    .danger-pulse {
      animation: pulse 2s infinite;
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel" data-type="module">
    // ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ã‚’1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«çµ±åˆ

    // ========== å®šæ•° ==========
    const DRINK_PRESETS = [
      { type: 'cocktail', name: 'ã‚«ã‚¯ãƒ†ãƒ«', defaultAlcoholPercentage: 3, defaultServingMl: 350 },
      { type: 'beer', name: 'ãƒ“ãƒ¼ãƒ«', defaultAlcoholPercentage: 5, defaultServingMl: 350 },
      { type: 'highball', name: 'ãƒã‚¤ãƒœãƒ¼ãƒ«', defaultAlcoholPercentage: 7, defaultServingMl: 350 },
      { type: 'chuhai', name: 'ãƒãƒ¥ãƒ¼ãƒã‚¤', defaultAlcoholPercentage: 5, defaultServingMl: 350 },
      { type: 'wine', name: 'ãƒ¯ã‚¤ãƒ³', defaultAlcoholPercentage: 12, defaultServingMl: 120 },
      { type: 'sake', name: 'æ—¥æœ¬é…’', defaultAlcoholPercentage: 15, defaultServingMl: 180 },
      { type: 'shochu', name: 'ç„¼é…', defaultAlcoholPercentage: 25, defaultServingMl: 60 },
      { type: 'whiskey', name: 'ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼', defaultAlcoholPercentage: 40, defaultServingMl: 30 },
    ];

    const BACKGROUND_EMOJIS = ['ğŸº', 'ğŸ»', 'ğŸ¾', 'ğŸ·', 'ğŸ¶', 'ğŸ¸', 'ğŸ¤¡', 'ğŸ˜š'];

    const THEME_COLORS = {
      primary: '#FFD700',
      secondary: '#FFA500',
      background: '#FFFACD',
      text: '#333333',
      border: '#FFB347',
    };

    // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ==========
    function calculatePureAlcohol(volumeMl, alcoholPercentage) {
      return volumeMl * (alcoholPercentage / 100);
    }

    function calculateDailyTotal(records) {
      return records.reduce((total, record) => {
        return total + calculatePureAlcohol(record.volumeMl, record.alcoholPercentage);
      }, 0);
    }

    const ALCOHOL_DENSITY = 0.789;
    const METABOLISM_RATE = 0.015;
    const DISTRIBUTION_VOLUME = { male: 0.68, female: 0.55 };

    function calculateBAC(pureAlcoholMl, weightKg, gender, hoursElapsed) {
      const alcoholGrams = pureAlcoholMl * ALCOHOL_DENSITY;
      const r = DISTRIBUTION_VOLUME[gender];
      // Widmarkå¼: BAC(%) = ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é‡(g) / (ä½“é‡(kg) Ã— åˆ†å¸ƒå®¹ç©) - ä»£è¬é€Ÿåº¦ Ã— æ™‚é–“
      // çµæœã¯%å˜ä½ï¼ˆ0.05 = 0.05%ï¼‰
      const bac = (alcoholGrams / (weightKg * r * 10)) - (METABOLISM_RATE * hoursElapsed);
      return Math.max(0, bac);
    }

    function calculateCurrentBAC(records, userProfile, currentTime) {
      let totalBAC = 0;
      records.forEach(record => {
        const drinkTime = new Date(record.timestamp);
        const hoursElapsed = (currentTime.getTime() - drinkTime.getTime()) / (1000 * 60 * 60);
        const bac = calculateBAC(
          calculatePureAlcohol(record.volumeMl, record.alcoholPercentage),
          userProfile.weight,
          userProfile.gender,
          hoursElapsed
        );
        totalBAC += bac;
      });
      return totalBAC;
    }

    function generateBACTimeSeries(records, userProfile) {
      if (records.length === 0) return [];
      const dataPoints = [];
      const now = new Date();
      const firstDrinkTime = new Date(Math.min(...records.map(r => new Date(r.timestamp).getTime())));
      const startTime = new Date(firstDrinkTime);
      startTime.setMinutes(Math.floor(startTime.getMinutes() / 15) * 15, 0, 0);
      const endTime = new Date(now.getTime() + 6 * 60 * 60 * 1000);

      for (let time = new Date(startTime); time <= endTime; time.setMinutes(time.getMinutes() + 15)) {
        const bac = calculateCurrentBAC(records, userProfile, time);
        dataPoints.push({
          timestamp: time.toISOString(),
          bac,
          isPrediction: time > now,
        });
      }
      return dataPoints;
    }

    function getTodayString() {
      const today = new Date();
      return today.toISOString().split('T')[0];
    }

    // ========== Context ==========
    const { createContext, useContext, useReducer, useEffect, useState, useRef } = React;
    const AppContext = createContext();

    const ACTIONS = {
      ADD_DRINK: 'ADD_DRINK',
      DELETE_DRINK: 'DELETE_DRINK',
      UPDATE_USER_PROFILE: 'UPDATE_USER_PROFILE',
      RESET_DAILY: 'RESET_DAILY',
      LOAD_STATE: 'LOAD_STATE',
    };

    function appReducer(state, action) {
      switch (action.type) {
        case ACTIONS.ADD_DRINK:
          return { ...state, drinkRecords: [...state.drinkRecords, action.payload] };
        case ACTIONS.DELETE_DRINK:
          return { ...state, drinkRecords: state.drinkRecords.filter(r => r.id !== action.payload) };
        case ACTIONS.UPDATE_USER_PROFILE:
          return { ...state, userProfile: action.payload };
        case ACTIONS.RESET_DAILY:
          return { ...state, drinkRecords: [], currentDate: action.payload };
        case ACTIONS.LOAD_STATE:
          return action.payload;
        default:
          return state;
      }
    }

    const initialState = {
      userProfile: null,
      drinkRecords: [],
      currentDate: getTodayString(),
    };

    function AppProvider({ children }) {
      const [state, dispatch] = useReducer(appReducer, initialState);

      useEffect(() => {
        try {
          const savedState = localStorage.getItem('nomisugiru-alert-state');
          if (savedState) {
            const parsed = JSON.parse(savedState);
            const today = getTodayString();
            if (parsed.currentDate !== today) {
              dispatch({ type: ACTIONS.RESET_DAILY, payload: today });
              if (parsed.userProfile) {
                dispatch({ type: ACTIONS.UPDATE_USER_PROFILE, payload: parsed.userProfile });
              }
            } else {
              dispatch({ type: ACTIONS.LOAD_STATE, payload: parsed });
            }
          }
        } catch (error) {
          console.error('Error loading state:', error);
        }
      }, []);

      useEffect(() => {
        try {
          localStorage.setItem('nomisugiru-alert-state', JSON.stringify(state));
        } catch (error) {
          console.error('Error saving state:', error);
        }
      }, [state]);

      useEffect(() => {
        const checkDate = () => {
          const today = getTodayString();
          if (state.currentDate !== today) {
            dispatch({ type: ACTIONS.RESET_DAILY, payload: today });
          }
        };
        const interval = setInterval(checkDate, 60000);
        return () => clearInterval(interval);
      }, [state.currentDate]);

      const addDrinkRecord = (record) => {
        const newRecord = {
          ...record,
          id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
          timestamp: record.customTimestamp || new Date().toISOString(),
        };
        delete newRecord.customTimestamp; // ä½¿ç”¨å¾Œã¯å‰Šé™¤
        dispatch({ type: ACTIONS.ADD_DRINK, payload: newRecord });
      };

      const deleteDrinkRecord = (id) => {
        dispatch({ type: ACTIONS.DELETE_DRINK, payload: id });
      };

      const updateUserProfile = (profile) => {
        dispatch({ type: ACTIONS.UPDATE_USER_PROFILE, payload: profile });
      };

      const clearAllRecords = () => {
        if (window.confirm('æœ¬æ—¥ã®è¨˜éŒ²ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          dispatch({ type: ACTIONS.RESET_DAILY, payload: getTodayString() });
        }
      };

      const value = { state, addDrinkRecord, deleteDrinkRecord, updateUserProfile, clearAllRecords };
      return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
    }

    function useApp() {
      const context = useContext(AppContext);
      if (!context) throw new Error('useApp must be used within AppProvider');
      return context;
    }

    // ========== ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ ==========
    function useBACCalculation(records, userProfile) {
      const [currentBAC, setCurrentBAC] = useState(0);
      const [bacTimeSeries, setBacTimeSeries] = useState([]);

      useEffect(() => {
        if (!userProfile || records.length === 0) {
          setCurrentBAC(0);
          setBacTimeSeries([]);
          return;
        }

        const updateBAC = () => {
          const now = new Date();
          const bac = calculateCurrentBAC(records, userProfile, now);
          setCurrentBAC(bac);
          const timeSeries = generateBACTimeSeries(records, userProfile);
          setBacTimeSeries(timeSeries);
        };

        updateBAC();
        const interval = setInterval(updateBAC, 60000);
        return () => clearInterval(interval);
      }, [records, userProfile]);

      return { currentBAC, bacTimeSeries };
    }

    // ========== ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ==========
    function EmojiBackground() {
      const emojis = BACKGROUND_EMOJIS;
      const emojiElements = [];
      const gridSize = 8; // 8x8ã®ã‚°ãƒªãƒƒãƒ‰ã§é…ç½®
      const positions = [];

      // ã‚°ãƒªãƒƒãƒ‰ãƒ™ãƒ¼ã‚¹ã§é‡ãªã‚‰ãªã„ã‚ˆã†ã«é…ç½®
      for (let row = 0; row < gridSize; row++) {
        for (let col = 0; col < gridSize; col++) {
          positions.push({
            top: (row * (100 / gridSize)) + (Math.random() * (100 / gridSize)),
            left: (col * (100 / gridSize)) + (Math.random() * (100 / gridSize))
          });
        }
      }

      // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
      positions.sort(() => Math.random() - 0.5);

      // 50å€‹ã®çµµæ–‡å­—ã‚’é…ç½®
      for (let i = 0; i < 50; i++) {
        const emoji = emojis[i % emojis.length];
        const pos = positions[i];
        const rotation = Math.random() * 360;
        const size = 2.5 + Math.random() * 1; // ã‚µã‚¤ã‚ºã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ï¼ˆ2.5remã€œ3.5remï¼‰
        const animationDelay = Math.random() * 20;
        emojiElements.push(
          <div key={i} className="emoji" style={{
            top: `${pos.top}%`,
            left: `${pos.left}%`,
            transform: `rotate(${rotation}deg)`,
            fontSize: `${size}rem`,
            animationDelay: `${animationDelay}s`
          }}>
            {emoji}
          </div>
        );
      }
      return <div className="emoji-background">{emojiElements}</div>;
    }

    function DailyIntakeDisplay({ totalPureAlcoholMl }) {
      return (
        <>
          <div className="text-center py-8 px-4 relative overflow-hidden" style={{ background: 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)' }}>
            <div className="relative z-10">
              <h1 className="text-5xl md:text-6xl font-bold text-white drop-shadow-lg">é£²ã¿éãalert</h1>
              <p className="text-white text-sm mt-2 opacity-90">ã‚ãªãŸã®é£²é…’ã‚’è¦‹å®ˆã‚Šã¾ã™</p>
            </div>
          </div>
          <div className="text-center py-8 px-4 mt-6 mx-4 rounded-2xl glass-card">
            <div className="text-sm font-medium mb-3 text-gray-600 uppercase tracking-wider">Today's Alcohol</div>
            <div className="flex items-baseline justify-center gap-2">
              <div className="text-7xl font-bold bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent">
                {totalPureAlcoholMl.toFixed(1)}
              </div>
              <span className="text-3xl font-semibold text-gray-600">ml</span>
            </div>
            <div className="mt-3 text-xs text-gray-500">ç´”ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ›ç®—</div>
          </div>
        </>
      );
    }

    function IntoxicationMeter({ currentBAC }) {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      const getColorForBAC = (bac) => {
        if (bac < 0.02) return '#4ade80';      // ç·‘: ã‚·ãƒ©ãƒ•
        if (bac < 0.04) return '#a3e635';      // é»„ç·‘: çˆ½å¿«æœŸ
        if (bac < 0.1) return '#fbbf24';       // é»„è‰²: ã»ã‚é…”ã„æœŸ
        if (bac < 0.15) return '#fb923c';      // ã‚ªãƒ¬ãƒ³ã‚¸: é…©é…ŠåˆæœŸ
        if (bac < 0.3) return '#f87171';       // èµ¤: é…©é…ŠæœŸ
        return '#dc2626';                       // æ¿ƒã„èµ¤: æ³¥é…”æœŸ
      };

      const getLabelForBAC = (bac) => {
        if (bac < 0.02) return 'ğŸ˜Š ã‚·ãƒ©ãƒ•';
        if (bac < 0.04) return 'ğŸ˜„ çˆ½å¿«æœŸ';
        if (bac < 0.1) return 'ğŸ˜œ ã»ã‚é…”ã„æœŸ';
        if (bac < 0.15) return 'ğŸ¥´ é…©é…ŠåˆæœŸ';
        if (bac < 0.3) return 'ğŸ‘¿ é…©é…ŠæœŸ';
        return 'ğŸ’€ æ³¥é…”æœŸ';
      };

      useEffect(() => {
        if (!canvasRef.current) return;
        const ctx = canvasRef.current.getContext('2d');
        if (chartRef.current) chartRef.current.destroy();

        // 0.3%ã‚’100%ã¨ã—ã¦è¡¨ç¤ºï¼ˆ0.3% = æ³¥é…”æœŸã®åŸºæº–ï¼‰
        const bacPercentage = Math.min((currentBAC / 0.3) * 100, 100);
        const color = getColorForBAC(currentBAC);

        chartRef.current = new Chart(ctx, {
          type: 'doughnut',
          data: {
            datasets: [{
              data: [bacPercentage, 100 - bacPercentage],
              backgroundColor: [color, '#e5e7eb'],
              borderWidth: 0,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '70%',
            plugins: { legend: { display: false }, tooltip: { enabled: false } }
          }
        });

        return () => { if (chartRef.current) chartRef.current.destroy(); };
      }, [currentBAC]);

      return (
        <div className="py-6 px-4" style={{ backgroundColor: THEME_COLORS.background }}>
          <h2 className="text-2xl font-bold text-center mb-4" style={{ color: THEME_COLORS.text }}>ç¾åœ¨ã®é…”ã„ãƒ¬ãƒ™ãƒ«</h2>

          <div className="max-w-2xl mx-auto flex items-center justify-center gap-6">
            <div className="w-64 relative flex-shrink-0">
              <canvas ref={canvasRef} />
              <div className="absolute inset-0 flex flex-col items-center justify-center">
                <div className="text-sm text-gray-600 mb-1">BAC</div>
                <div className="text-4xl font-bold" style={{ color: THEME_COLORS.text }}>
                  {currentBAC.toFixed(2)}%
                </div>
                <div className="text-xl mt-2" style={{ color: THEME_COLORS.text }}>{getLabelForBAC(currentBAC)}</div>
              </div>
            </div>

            <div className="bg-white rounded-lg p-3 shadow text-xs">
              <div className="font-bold mb-2 text-center" style={{ color: THEME_COLORS.text }}>åŸºæº–</div>
              <div className="space-y-1">
                <div className="flex items-center gap-1">
                  <span>ğŸ˜Š</span>
                  <span className="w-16">ã‚·ãƒ©ãƒ•</span>
                  <span className="text-gray-600">0-0.02%</span>
                </div>
                <div className="flex items-center gap-1">
                  <span>ğŸ˜„</span>
                  <span className="w-16">çˆ½å¿«æœŸ</span>
                  <span className="text-gray-600">0.02-0.04%</span>
                </div>
                <div className="flex items-center gap-1">
                  <span>ğŸ˜œ</span>
                  <span className="w-16">ã»ã‚é…”ã„</span>
                  <span className="text-gray-600">0.04-0.1%</span>
                </div>
                <div className="flex items-center gap-1">
                  <span>ğŸ¥´</span>
                  <span className="w-16">é…©é…ŠåˆæœŸ</span>
                  <span className="text-gray-600">0.1-0.15%</span>
                </div>
                <div className="flex items-center gap-1">
                  <span>ğŸ‘¿</span>
                  <span className="w-16">é…©é…ŠæœŸ</span>
                  <span className="text-gray-600">0.15-0.3%</span>
                </div>
                <div className="flex items-center gap-1">
                  <span>ğŸ’€</span>
                  <span className="w-16">æ³¥é…”æœŸ</span>
                  <span className="text-red-600 font-bold">0.3%ä»¥ä¸Š</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function UserSettingsModal({ isOpen, onClose, onSave, currentProfile }) {
      const [weight, setWeight] = useState(currentProfile?.weight || 60);
      const [gender, setGender] = useState(currentProfile?.gender || 'male');
      const [error, setError] = useState('');

      const handleSave = () => {
        if (weight < 20 || weight > 200) {
          setError('ä½“é‡ã¯20kgã€œ200kgã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        onSave({
          weight: parseFloat(weight),
          gender,
          createdAt: currentProfile?.createdAt || new Date().toISOString(),
        });
        setError('');
        onClose();
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={(e) => { if (e.target === e.currentTarget) onClose(); }}>
          <div className="bg-white rounded-lg p-6 max-w-md w-full" style={{ backgroundColor: THEME_COLORS.background }}>
            <h2 className="text-2xl font-bold mb-4" style={{ color: THEME_COLORS.text }}>ä½“æ ¼æƒ…å ±ã®è¨­å®š</h2>
            <div className="mb-4">
              <label className="block text-sm font-medium mb-2" style={{ color: THEME_COLORS.text }}>ä½“é‡ï¼ˆkgï¼‰</label>
              <input type="number" value={weight} onChange={(e) => setWeight(e.target.value)} className="w-full px-3 py-2 border rounded-lg" min="20" max="200" step="0.1" />
            </div>
            <div className="mb-4">
              <label className="block text-sm font-medium mb-2" style={{ color: THEME_COLORS.text }}>æ€§åˆ¥</label>
              <div className="flex gap-4">
                <label className="flex items-center">
                  <input type="radio" value="male" checked={gender === 'male'} onChange={(e) => setGender(e.target.value)} className="mr-2" />
                  ç”·æ€§
                </label>
                <label className="flex items-center">
                  <input type="radio" value="female" checked={gender === 'female'} onChange={(e) => setGender(e.target.value)} className="mr-2" />
                  å¥³æ€§
                </label>
              </div>
            </div>
            {error && <div className="mb-4 text-red-600 text-sm">{error}</div>}
            <div className="flex gap-2">
              <button onClick={handleSave} className="flex-1 py-2 px-4 rounded-lg font-semibold" style={{ backgroundColor: THEME_COLORS.primary, color: THEME_COLORS.text }}>ä¿å­˜</button>
              {currentProfile && <button onClick={onClose} className="flex-1 py-2 px-4 rounded-lg font-semibold bg-gray-300" style={{ color: THEME_COLORS.text }}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>}
            </div>
          </div>
        </div>
      );
    }

    function DrinkRecorder({ onAddDrink }) {
      const [selectedDrinks, setSelectedDrinks] = useState([]);
      const [customName, setCustomName] = useState('');
      const [customPercentage, setCustomPercentage] = useState('');
      const [customVolume, setCustomVolume] = useState('');
      const [customTime, setCustomTime] = useState('');
      const [isCustomMode, setIsCustomMode] = useState(false);
      const [error, setError] = useState('');

      const addDrinkToList = (preset) => {
        // æ—¢ã«åŒã˜é£²ã¿ç‰©ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        const existingDrink = selectedDrinks.find(d => d.preset.type === preset.type);

        if (existingDrink) {
          // æ—¢ã«ã‚ã‚‹å ´åˆã¯æ¯æ•°ã‚’å¢—ã‚„ã™
          setSelectedDrinks(selectedDrinks.map(d =>
            d.preset.type === preset.type
              ? { ...d, servings: d.servings + 1, volumeMl: d.preset.defaultServingMl * (d.servings + 1) }
              : d
          ));
        } else {
          // æ–°ã—ãè¿½åŠ 
          const newDrink = {
            id: Date.now() + Math.random(),
            preset,
            servings: 1,
            volumeMl: preset.defaultServingMl
          };
          setSelectedDrinks([...selectedDrinks, newDrink]);
        }
        setError('');
      };

      const updateDrinkServings = (id, servings) => {
        const num = parseInt(servings) || 1;
        if (num < 1 || num > 99) return;
        setSelectedDrinks(selectedDrinks.map(d =>
          d.id === id ? { ...d, servings: num, volumeMl: d.preset.defaultServingMl * num } : d
        ));
      };

      const updateDrinkVolume = (id, volume) => {
        const num = parseFloat(volume) || 0;
        setSelectedDrinks(selectedDrinks.map(d => {
          if (d.id === id) {
            const servings = Math.round(num / d.preset.defaultServingMl) || 1;
            return { ...d, volumeMl: num, servings };
          }
          return d;
        }));
      };

      const removeDrink = (id) => {
        setSelectedDrinks(selectedDrinks.filter(d => d.id !== id));
      };

      const handleSubmit = () => {
        if (isCustomMode) {
          const vol = parseFloat(customVolume);
          const perc = parseFloat(customPercentage);
          if (!customName || !vol || !perc) {
            setError('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
          }
          if (vol < 1 || vol > 10000) {
            setError('é‡ã¯1ã€œ10000mlã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
          }
          if (perc < 0 || perc > 100) {
            setError('ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«åº¦æ•°ã¯0ã€œ100%ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
          }
          const drinkData = { drinkType: 'custom', customName, alcoholPercentage: perc, volumeMl: vol };
          // æ™‚åˆ»ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä½¿ç”¨
          if (customTime) {
            const today = new Date();
            const [hours, minutes] = customTime.split(':');
            today.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            drinkData.customTimestamp = today.toISOString();
          }
          onAddDrink(drinkData);
          setCustomName('');
          setCustomPercentage('');
          setCustomVolume('');
          setCustomTime('');
          setError('');
        } else {
          if (selectedDrinks.length === 0) {
            setError('é£²ã¿ç‰©ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
          }
          // è¤‡æ•°ã®é£²ã¿ç‰©ã‚’ä¸€æ°—ã«è¨˜éŒ²ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—IDã‚’ä»˜ä¸ï¼‰
          const groupId = Date.now().toString();
          selectedDrinks.forEach(drink => {
            onAddDrink({
              drinkType: drink.preset.type,
              customName: drink.preset.name,
              alcoholPercentage: drink.preset.defaultAlcoholPercentage,
              volumeMl: drink.volumeMl,
              groupId: groupId, // ã‚°ãƒ«ãƒ¼ãƒ—IDã‚’è¿½åŠ 
            });
          });
          setSelectedDrinks([]);
          setError('');
        }
      };

      return (
        <div className="py-6 px-4" style={{ backgroundColor: 'white', borderTop: `2px solid ${THEME_COLORS.border}` }}>
          <h2 className="text-2xl font-bold mb-4" style={{ color: THEME_COLORS.text }}>é£²ã¿ç‰©ã‚’è¨˜éŒ²</h2>
          <div className="flex gap-2 mb-4">
            <button onClick={() => setIsCustomMode(false)} className={`px-4 py-2 rounded-lg font-semibold ${!isCustomMode ? 'opacity-100' : 'opacity-50'}`} style={{ backgroundColor: THEME_COLORS.primary, color: THEME_COLORS.text }}>ãƒ—ãƒªã‚»ãƒƒãƒˆ</button>
            <button onClick={() => setIsCustomMode(true)} className={`px-4 py-2 rounded-lg font-semibold ${isCustomMode ? 'opacity-100' : 'opacity-50'}`} style={{ backgroundColor: THEME_COLORS.primary, color: THEME_COLORS.text }}>æ‰‹å…¥åŠ›</button>
          </div>
          {!isCustomMode && (
            <div>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                {DRINK_PRESETS.map(preset => (
                  <button key={preset.type} onClick={() => addDrinkToList(preset)} className="drink-button py-4 px-3 rounded-xl font-bold text-white relative overflow-hidden" style={{ background: 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)' }}>
                    <div className="relative z-10">
                      <div className="text-2xl mb-1">
                        {preset.type === 'beer' ? 'ğŸº' : preset.type === 'wine' ? 'ğŸ·' : preset.type === 'sake' ? 'ğŸ¶' : preset.type === 'whiskey' ? 'ğŸ¥ƒ' : preset.type === 'cocktail' ? 'ğŸ¹' : preset.type === 'highball' ? 'ğŸ¥¤' : preset.type === 'chuhai' ? 'ğŸ‹' : 'ğŸ¸'}
                      </div>
                      <div className="text-sm">{preset.name}</div>
                      <div className="text-xs opacity-80">{preset.defaultAlcoholPercentage}%</div>
                    </div>
                  </button>
                ))}
              </div>
              {selectedDrinks.length > 0 && (
                <div className="space-y-3 mb-4 p-4 glass-card rounded-xl">
                  <div className="font-bold mb-3 text-center text-lg" style={{ color: THEME_COLORS.text }}>ğŸ›’ é¸æŠä¸­ã®é£²ã¿ç‰©</div>
                  {selectedDrinks.map(drink => (
                    <div key={drink.id} className="flex items-center gap-2 bg-gradient-to-r from-yellow-50 to-orange-50 p-3 rounded-lg border-2 border-yellow-200">
                      <div className="w-24 flex-shrink-0 font-bold text-orange-700">{drink.preset.name}</div>
                      <input type="number" value={drink.servings} onChange={(e) => updateDrinkServings(drink.id, e.target.value)} className="w-16 px-2 py-2 border-2 border-yellow-300 rounded-lg text-center font-semibold" min="1" max="99" step="1" />
                      <span className="text-sm w-8 font-medium">æ¯</span>
                      <input type="number" value={drink.volumeMl} onChange={(e) => updateDrinkVolume(drink.id, e.target.value)} className="w-20 px-2 py-2 border-2 border-yellow-300 rounded-lg text-center font-semibold" min="50" step="50" />
                      <span className="text-sm w-8 font-medium">ml</span>
                      <button onClick={() => removeDrink(drink.id)} className="ml-auto px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-semibold transition-all">ğŸ—‘ï¸</button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {isCustomMode && (
            <div className="space-y-3">
              <div>
                <label className="block text-sm font-medium mb-1" style={{ color: THEME_COLORS.text }}>é£²ã¿ç‰©ã®åå‰</label>
                <input type="text" value={customName} onChange={(e) => setCustomName(e.target.value)} className="w-full px-3 py-2 border rounded-lg" placeholder="ä¾‹: ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼" />
              </div>
              <div className="flex gap-4">
                <div className="flex-1">
                  <label className="block text-sm font-medium mb-1" style={{ color: THEME_COLORS.text }}>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«åº¦æ•°ï¼ˆ%ï¼‰</label>
                  <input type="number" value={customPercentage} onChange={(e) => setCustomPercentage(e.target.value)} className="w-full px-3 py-2 border rounded-lg" min="0" max="100" step="0.1" placeholder="ä¾‹: 40" />
                </div>
                <div className="flex-1">
                  <label className="block text-sm font-medium mb-1" style={{ color: THEME_COLORS.text }}>é‡ï¼ˆmlï¼‰</label>
                  <input type="number" value={customVolume} onChange={(e) => setCustomVolume(e.target.value)} className="w-full px-3 py-2 border rounded-lg" min="1" step="1" placeholder="ä¾‹: 30" />
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1" style={{ color: THEME_COLORS.text }}>æ™‚åˆ»ï¼ˆçœç•¥å¯ï¼‰</label>
                <input type="time" value={customTime} onChange={(e) => setCustomTime(e.target.value)} className="w-full px-3 py-2 border rounded-lg" />
                <p className="text-xs text-gray-500 mt-1">â€» ç©ºæ¬„ã®å ´åˆã¯ç¾åœ¨æ™‚åˆ»ãŒä½¿ç”¨ã•ã‚Œã¾ã™</p>
              </div>
            </div>
          )}
          {error && <div className="mt-3 text-red-600 text-sm">{error}</div>}
          <button onClick={handleSubmit} className="w-full mt-6 py-4 rounded-xl font-bold text-xl text-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105 active:scale-95" style={{ background: 'linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%)' }}>
            âœ¨ è¨˜éŒ²ã™ã‚‹ âœ¨
          </button>
        </div>
      );
    }

    function DrinkTimeline({ records, onDeleteRecord }) {
      if (records.length === 0) {
        return (
          <div className="py-6 px-4 text-center" style={{ backgroundColor: THEME_COLORS.background }}>
            <p className="text-gray-500">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
          </div>
        );
      }

      const sortedRecords = [...records].sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime());

      // ã‚°ãƒ«ãƒ¼ãƒ—IDã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const groupedRecords = [];
      const processedGroups = new Set();

      sortedRecords.forEach(record => {
        if (record.groupId && !processedGroups.has(record.groupId)) {
          // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸè¨˜éŒ²
          const groupRecords = sortedRecords.filter(r => r.groupId === record.groupId);
          groupedRecords.push({ isGroup: true, records: groupRecords, groupId: record.groupId });
          processedGroups.add(record.groupId);
        } else if (!record.groupId) {
          // å˜ç‹¬ã®è¨˜éŒ²
          groupedRecords.push({ isGroup: false, record });
        }
      });

      return (
        <div className="py-6 px-4" style={{ backgroundColor: THEME_COLORS.background }}>
          <h2 className="text-2xl font-bold mb-4" style={{ color: THEME_COLORS.text }}>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h2>
          <div className="space-y-3">
            {groupedRecords.map((item, index) => {
              if (item.isGroup) {
                // ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤º
                const time = new Date(item.records[0].timestamp);
                const timeStr = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
                const totalPureAlcohol = item.records.reduce((sum, r) => sum + calculatePureAlcohol(r.volumeMl, r.alcoholPercentage), 0);

                return (
                  <div key={item.groupId} className="p-3 bg-white rounded-lg shadow">
                    <div className="flex items-start gap-3 mb-2">
                      <div className="flex-shrink-0 w-16 text-center">
                        <div className="text-lg font-bold" style={{ color: THEME_COLORS.text }}>{timeStr}</div>
                      </div>
                      <div className="flex-1">
                        {item.records.map(record => {
                          const pureAlcohol = calculatePureAlcohol(record.volumeMl, record.alcoholPercentage);
                          return (
                            <div key={record.id} className="text-sm text-gray-700">
                              {record.customName || record.drinkType} {record.volumeMl}ml ({record.alcoholPercentage}%) = {pureAlcohol.toFixed(1)}ml
                            </div>
                          );
                        })}
                      </div>
                      <button onClick={() => item.records.forEach(r => onDeleteRecord(r.id))} className="flex-shrink-0 px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">å…¨å‰Šé™¤</button>
                    </div>
                  </div>
                );
              } else {
                // å˜ç‹¬è¡¨ç¤º
                const record = item.record;
                const time = new Date(record.timestamp);
                const timeStr = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
                const pureAlcohol = calculatePureAlcohol(record.volumeMl, record.alcoholPercentage);

                return (
                  <div key={record.id} className="flex items-center gap-3 p-3 bg-white rounded-lg shadow">
                    <div className="flex-shrink-0 w-16 text-center">
                      <div className="text-lg font-bold" style={{ color: THEME_COLORS.text }}>{timeStr}</div>
                    </div>
                    <div className="flex-1">
                      <div className="font-semibold" style={{ color: THEME_COLORS.text }}>{record.customName || record.drinkType}</div>
                      <div className="text-sm text-gray-600">{record.volumeMl}ml ({record.alcoholPercentage}%) = ç´”ã‚¢ãƒ«ã‚³ãƒ¼ãƒ« {pureAlcohol.toFixed(1)}ml</div>
                    </div>
                    <button onClick={() => onDeleteRecord(record.id)} className="flex-shrink-0 px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">å‰Šé™¤</button>
                  </div>
                );
              }
            })}
          </div>
        </div>
      );
    }

    function BACGraph({ dataPoints }) {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!canvasRef.current || dataPoints.length === 0) return;
        const ctx = canvasRef.current.getContext('2d');
        if (chartRef.current) chartRef.current.destroy();

        const pastData = dataPoints.filter(d => !d.isPrediction);
        const futureData = dataPoints.filter(d => d.isPrediction);
        if (pastData.length > 0 && futureData.length > 0) {
          futureData.unshift(pastData[pastData.length - 1]);
        }

        chartRef.current = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [
              {
                label: 'éå»',
                data: pastData.map(d => ({ x: d.timestamp, y: d.bac })),
                borderColor: THEME_COLORS.secondary,
                backgroundColor: THEME_COLORS.secondary + '40',
                borderWidth: 3,
                tension: 0.4,
                fill: false,
              },
              {
                label: 'äºˆæ¸¬',
                data: futureData.map(d => ({ x: d.timestamp, y: d.bac })),
                borderColor: '#9ca3af',
                backgroundColor: '#9ca3af40',
                borderWidth: 2,
                borderDash: [5, 5],
                tension: 0.4,
                fill: false,
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                type: 'time',
                time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                title: { display: true, text: 'æ™‚åˆ»' }
              },
              y: {
                beginAtZero: true,
                title: { display: true, text: 'è¡€ä¸­ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¿ƒåº¦ï¼ˆ%ï¼‰' },
                ticks: {
                  callback: function (value) { return value.toFixed(2) + '%'; },
                  stepSize: 0.05
                }
              }
            },
            plugins: {
              legend: { display: true, position: 'top' },
              tooltip: { callbacks: { label: function (context) { return `BAC: ${context.parsed.y.toFixed(2)}%`; } } }
            }
          }
        });

        return () => { if (chartRef.current) chartRef.current.destroy(); };
      }, [dataPoints]);

      if (dataPoints.length === 0) {
        return (
          <div className="py-6 px-4 text-center" style={{ backgroundColor: 'white' }}>
            <p className="text-gray-500">é£²ã¿ç‰©ã‚’è¨˜éŒ²ã™ã‚‹ã¨ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
          </div>
        );
      }

      return (
        <div className="py-6 px-4" style={{ backgroundColor: 'white' }}>
          <h2 className="text-2xl font-bold mb-4" style={{ color: THEME_COLORS.text }}>è¡€ä¸­ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¿ƒåº¦ã®æ¨ç§»</h2>
          <div style={{ height: '300px' }}>
            <canvas ref={canvasRef} />
          </div>
        </div>
      );
    }

    // ========== ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª ==========
    function App() {
      const { state, addDrinkRecord, deleteDrinkRecord, updateUserProfile, clearAllRecords } = useApp();
      const [showSettings, setShowSettings] = useState(false);
      const { currentBAC, bacTimeSeries } = useBACCalculation(state.drinkRecords, state.userProfile);

      useEffect(() => {
        if (!state.userProfile) setShowSettings(true);
      }, [state.userProfile]);

      const totalPureAlcohol = calculateDailyTotal(state.drinkRecords);

      return (
        <div className="min-h-screen" style={{ position: 'relative' }}>
          <EmojiBackground />
          <div className="content-wrapper max-w-4xl mx-auto">
            <DailyIntakeDisplay totalPureAlcoholMl={totalPureAlcohol} />
            <div className="text-center py-2 flex gap-2 justify-center px-4">
              <button onClick={() => setShowSettings(true)} className="px-4 py-2 rounded-lg font-semibold" style={{ backgroundColor: THEME_COLORS.secondary, color: 'white' }}>
                {state.userProfile ? 'ä½“æ ¼æƒ…å ±ã‚’å¤‰æ›´' : 'ä½“æ ¼æƒ…å ±ã‚’è¨­å®š'}
              </button>
              {state.drinkRecords.length > 0 && (
                <button onClick={clearAllRecords} className="px-4 py-2 rounded-lg font-semibold bg-red-500 text-white hover:bg-red-600">
                  ã™ã¹ã¦ã‚¯ãƒªã‚¢
                </button>
              )}
            </div>
            {state.userProfile && <IntoxicationMeter currentBAC={currentBAC} />}
            {state.userProfile && <DrinkRecorder onAddDrink={addDrinkRecord} />}
            <DrinkTimeline records={state.drinkRecords} onDeleteRecord={deleteDrinkRecord} />
            {state.userProfile && <BACGraph dataPoints={bacTimeSeries} />}
            <div className="text-center py-8 text-sm text-gray-600">
              â€» è¡€ä¸­ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¿ƒåº¦ã¯ç›®å®‰ã§ã™ã€‚å®Ÿéš›ã®å€¤ã¨ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
            </div>
          </div>
          <UserSettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} onSave={updateUserProfile} currentProfile={state.userProfile} />
        </div>
      );
    }

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒã‚¦ãƒ³ãƒˆ
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AppProvider><App /></AppProvider>);
  </script>
</body>

</html>